<html>
  <body>
    <script src="https://unpkg.com/read-excel-file@4.x/bundle/read-excel-file.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <input type="file" id="input" />
    <br />
    <select id="mySelect"></select>
    <div id="chart" style="width:100%;height:100%;"></div>

    <script>
      var readings = {}

      function checkDataComplete (data) {
        for (i = 0; i < data.val.length; i++) {
          if (data.val[i] === 'x' || data.min[i] === 'x' || data.max[i] === 'x')
            return false
        }
        return true
      }

      function plot () {
        const combo = document.getElementById('mySelect')
        var key = combo.options[combo.selectedIndex].text
        data = readings[key]

        if (!checkDataComplete(data)) {
          alert('incomplete data for:' + key)
          return
        }

        errorUp = []
        errorDown = []
        for (i = 0; i < data.val.length; i++) {
          errorUp[i] = data.max[i] - data.val[i]
          errorDown[i] = data.val[i] - data.min[i]
        }

        var trace1 = {
          x: ['p1', 'p2', 'p3', 'p4', 'p5', 'p6'],
          y: data.val,
          name: 'Control',
          error_y: {
            type: 'data',
            symmetric: false,
            array: errorUp,
            arrayminus: errorDown,
            visible: true
          },
          type: 'bar'
        }

        var layout = { barmode: 'group' }
        Plotly.newPlot('chart', [trace1])
      }

      function get_values (rows, col_index, sources) {
        ;(val = []), (min = []), (max = [])
        for (index = 0; index < sources; index++) {
          val[index] = rows[index + FIRST_SOURCE_ROW][col_index]
          min[index] = rows[index + FIRST_SOURCE_ROW][col_index + 1]
          max[index] = rows[index + FIRST_SOURCE_ROW][col_index + 2]
        }
        return { val: val, min: min, max: max }
      }

      function addComboOptions (readings) {
        var x = document.getElementById('mySelect')
        for (var key in readings) {
          var option = document.createElement('option')
          option.text = key
          x.add(option)
        }
      }

      const input = document.getElementById('input')
      input.addEventListener('change', readXml)

      const combo = document.getElementById('mySelect')

      combo.addEventListener('change', plot)

      async function readXml () {
        rows = await readXlsxFile(input.files[0], { sheet: 'PlanSum+robust' })

        header = rows[1]
        col = 0
        while (header[col] != '' && header[col] != 'PTV_1_volume') col++
        col++
        FIRST_SOURCE_ROW = 2
        sources = 0 // number of sources - items in PTV_1_volume column

        while (
          rows[FIRST_SOURCE_ROW + sources] &&
          rows[FIRST_SOURCE_ROW + sources][col] != ''
        )
          sources++

        while (header[col] != undefined && header[col] != '') {
          origName = header[col]

          name = header[col].replaceAll('_', '').toLowerCase()
          if (
            header[col + 1].replaceAll('_', '').toLowerCase() ===
              name + 'min' &&
            header[col + 2].replaceAll('_', '').toLowerCase() === name + 'max'
          ) {
            data = get_values(rows, col, sources)
            readings[origName] = data
            col += 3
          } else {
            console.log('alone', name)
            col++
          }
        }
        addComboOptions(readings)
      }
    </script>
  </body>
</html>
